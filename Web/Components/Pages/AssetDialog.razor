@using  Application.DTO
@using System.ComponentModel.DataAnnotations
@using Domain.Entities
@using Application.Interfaces
@using MudBlazor

@inject IAssetService AssetService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(IsEdit ? Icons.Material.Filled.Edit : Icons.Material.Filled.Add)" Class="mr-2 mb-n1" />
            @(IsEdit ? "Edit Asset" : "Add New Asset")
        </MudText>
    </TitleContent>
    <DialogContent>
        <EditForm Model="@Model" OnValidSubmit="SubmitForm">
            <DataAnnotationsValidator />
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField Label="Name" @bind-Value="Model.Name" For="@(() => Model.Name)" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Label="Category" @bind-Value="Model.Category" For="@(() => Model.Category)" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudNumericField Label="Current Value" @bind-Value="Model.CurrentValue" For="@(() => Model.CurrentValue)" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField Label="Currency" @bind-Value="Model.Currency" For="@(() => Model.Currency)" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudDatePicker Label="Purchase Date" 
                                   Date="@Model.PurchaseDate" 
                                   DateChanged="@((DateTime? d) => Model.PurchaseDate = d ?? DateTime.Today)" 
                                   For="@(() => Model.PurchaseDate)" 
                                   Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudNumericField Label="Purchase Value" @bind-Value="Model.PurchaseValue" For="@(() => Model.PurchaseValue)" Variant="Variant.Outlined" Format="N2" />
                </MudItem>
            </MudGrid>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitForm">@(IsEdit ? "Update Asset" : "Add Asset")</MudButton>
    </DialogActions>
</MudDialog>

@code{
    [CascadingParameter] IMudDialogInstance DialogInstance { get; set; } = default!;

    [Parameter] public AssetCreateDTO Model { get; set; } = new();
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public int AssetId { get; set; }

    private void SubmitForm()
    {
        try
        {
            if (IsEdit)
            {
                var updateDto = new AssetUpdateDTO
                {
                    Name = Model.Name,
                    Category = Model.Category,
                    CurrentValue = Model.CurrentValue,
                    PurchaseValue = Model.PurchaseValue,
                    PurchaseDate = Model.PurchaseDate,
                    Currency = Model.Currency,
                    CreatedAt = Model.CreatedAt
                };
                AssetService.UpdateAsset(AssetId, updateDto);
                Snackbar.Add("Asset updated successfully!", Severity.Success);
            }
            else
            {
                Model.CreatedAt = DateTime.Now;
                AssetService.CreateAsset(Model);
                Snackbar.Add("Asset created successfully!", Severity.Success);
            }
            DialogInstance.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => DialogInstance.Cancel();
}