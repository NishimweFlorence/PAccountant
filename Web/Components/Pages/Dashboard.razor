@page "/"
@using Application.Interfaces
@using Application.DTO
@using Domain.Entities
@rendermode InteractiveServer

@inject ILiabilityService LiabilityService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Dashboard — PAccountant</PageTitle>


<div class="pa-4">

    <div class="d-flex justify-space-between align-end mb-8 pb-4" style="border-bottom: 1px solid var(--mud-palette-divider);">
        <div>
            <MudText Typo="Typo.h3" Color="Color.Primary" Style="font-weight: 800;">PAccountant</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary" Class="mt-1">Personal Finance Dashboard</MudText>
        </div>
        <div class="text-right">
            <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 700;">@DateTime.Now.ToString("dd MMM yyyy")</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">@DateTime.Now.ToString("dddd")</MudText>
        </div>
    </div>

    @if (!IsLoading && OverdueCount > 0)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-6 rounded-lg">
            You have <strong>@OverdueCount overdue @(OverdueCount == 1 ? "liability" : "liabilities")</strong>
            totalling <strong>@OverdueTotal.ToString("N2")</strong>. Review them immediately.
        </MudAlert>
    }

    <MudGrid Class="mb-8">
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-6 rounded-xl border-t-4" Style="border-top-color: var(--mud-palette-primary);">
                <div class="d-flex align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Color="Color.Primary" Class="mr-3" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase" Style="letter-spacing: 1px;">Total Liabilities</MudText>
                </div>
                <MudText Typo="Typo.h4" Style="font-weight: 700;">@(IsLoading ? "—" : Liabilities.Count.ToString())</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1 d-block">Active obligations tracked</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-6 rounded-xl border-t-4" Style="border-top-color: var(--mud-palette-error);">
                <div class="d-flex align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Error" Class="mr-3" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase" Style="letter-spacing: 1px;">Original Debt</MudText>
                </div>
                <MudText Typo="Typo.h4" Style="font-weight: 700;">@(IsLoading ? "—" : TotalOriginal.ToString("N0"))</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1 d-block">Sum of all original amounts</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-6 rounded-xl border-t-4" Style="border-top-color: var(--mud-palette-warning);">
                <div class="d-flex align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Color="Color.Warning" Class="mr-3" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase" Style="letter-spacing: 1px;">Current Balance</MudText>
                </div>
                <MudText Typo="Typo.h4" Style="font-weight: 700;">@(IsLoading ? "—" : TotalCurrent.ToString("N0"))</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1 d-block">Still owed across all debts</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-6 rounded-xl border-t-4" Style="border-top-color: var(--mud-palette-success);">
                <div class="d-flex align-center mb-3">
                    <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Color="Color.Success" Class="mr-3" />
                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-uppercase" Style="letter-spacing: 1px;">Total Paid Off</MudText>
                </div>
                <MudText Typo="Typo.h4" Style="font-weight: 700;">@(IsLoading ? "—" : TotalPaidOff.ToString("N0"))</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1 d-block">@OverallPayoffPct% of total cleared</MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mb-8">
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="rounded-xl overflow-hidden">
                <div class="px-6 py-4 d-flex justify-space-between align-center" style="border-bottom: 1px solid var(--mud-palette-divider);">
                    <MudText Typo="Typo.h6" Style="font-weight: 700;">All Liabilities</MudText>
                    <MudButton Href="/liabilities/create" StartIcon="@Icons.Material.Filled.Add" Color="Color.Primary" Size="Size.Small">New</MudButton>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    @if (IsLoading)
                    {
                        <div class="pa-6">
                            <MudSkeleton Width="80%" Height="40px" Class="mb-2" />
                            <MudSkeleton Width="70%" Height="40px" Class="mb-2" />
                            <MudSkeleton Width="90%" Height="40px" Class="mb-2" />
                        </div>
                    }
                    else if (!Liabilities.Any())
                    {
                        <div class="pa-12 text-center opacity-50">
                            <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Class="mb-2" />
                            <MudText>No liabilities recorded yet.</MudText>
                            <MudLink Href="/liabilities/create" Underline="Underline.Hover">Add your first one</MudLink>
                        </div>
                    }
                    else
                    {
                        @foreach (var l in Liabilities.OrderBy(x => x.DueDate))
                        {
                            var daysLeft = (l.DueDate - DateTime.Today).Days;
                            var color = daysLeft < 0 ? Color.Error : daysLeft <= 30 ? Color.Warning : Color.Success;
                            
                            <div class="px-6 py-4 d-flex align-center hover-row pointer" @onclick="@(() => NavigationManager.NavigateTo("/liabilities"))" style="border-bottom: 1px solid var(--mud-palette-background-grey);">
                                <div class="flex-grow-1">
                                    <MudText Typo="Typo.body1" Style="font-weight: 600;">@l.LenderName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@l.Type</MudText>
                                </div>
                                <div class="text-right mr-4">
                                    <MudText Typo="Typo.body2" Color="Color.Primary" Style="font-weight: 700;">@l.Currency @l.CurrentAmount.ToString("N0")</MudText>
                                </div>
                                <MudChip T="string" Size="Size.Small" Color="color" Variant="Variant.Outlined">
                                    @(daysLeft < 0 ? $"{Math.Abs(daysLeft)}d overdue" : daysLeft == 0 ? "Due today" : $"{daysLeft}d left")
                                </MudChip>
                            </div>
                        }
                    }
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="pa-6 rounded-xl h-100">
                <MudText Typo="Typo.h6" Class="mb-6" Style="font-weight: 700;">Payoff Progress</MudText>
                @if (IsLoading)
                {
                    <MudSkeleton Width="100%" Height="20px" Class="mb-4" />
                    <MudSkeleton Width="100%" Height="20px" Class="mb-4" />
                    <MudSkeleton Width="100%" Height="20px" Class="mb-4" />
                }
                else if (!Liabilities.Any())
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No data to display.</MudText>
                }
                else
                {
                    @foreach (var l in Liabilities.Where(x => x.OriginalAmount > 0).OrderByDescending(x => x.OriginalAmount).Take(5))
                    {
                        var pct = (int)Math.Clamp((l.OriginalAmount - l.CurrentAmount) / l.OriginalAmount * 100, 0, 100);
                        var color = pct >= 75 ? Color.Success : pct >= 40 ? Color.Primary : Color.Error;

                        <div class="mb-4">
                            <div class="d-flex justify-space-between mb-1">
                                <MudText Typo="Typo.caption" Style="font-weight: 600;">@l.LenderName</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Primary" Style="font-weight: 700;">@pct%</MudText>
                            </div>
                            <MudProgressLinear Value="@pct" Color="color" Size="Size.Small" Rounded="true" />
                        </div>
                    }

                    <div class="mt-8 pt-6" style="border-top: 1px solid var(--mud-palette-divider);">
                        <div class="d-flex justify-space-between mb-2">
                            <MudText Typo="Typo.body2" Color="Color.Primary" Style="font-weight: 700;">Overall Progress</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Primary" Style="font-weight: 900;">@OverallPayoffPct%</MudText>
                        </div>
                        <MudProgressLinear Value="@OverallPayoffPct" Color="Color.Primary" Size="Size.Medium" Rounded="true" />
                    </div>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 700; color: var(--mud-palette-primary);">Quick Actions</MudText>
    <MudGrid>
        <MudItem xs="6" sm="3">
            <MudLink Href="/liabilities/create" Underline="Underline.None">
                <MudPaper Elevation="2" Class="pa-4 rounded-xl d-flex align-center hover-card pointer">
                    <MudIcon Icon="@Icons.Material.Filled.Add" Color="Color.Primary" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">New Liability</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Record debt</MudText>
                    </div>
                </MudPaper>
            </MudLink>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudLink Href="/liabilities" Underline="Underline.None">
                <MudPaper Elevation="2" Class="pa-4 rounded-xl d-flex align-center hover-card pointer">
                    <MudIcon Icon="@Icons.Material.Filled.List" Color="Color.Success" Class="mr-3" />
                    <div>
                        <MudText Typo="Typo.body2" Style="font-weight: 600;">View All</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Manage all</MudText>
                    </div>
                </MudPaper>
            </MudLink>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="2" Class="pa-4 rounded-xl d-flex align-center hover-card pointer" @onclick="RefreshData">
                <MudIcon Icon="@Icons.Material.Filled.Refresh" Color="Color.Info" Class="mr-3" />
                <div>
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">Refresh</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">Update charts</MudText>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="6" sm="3">
            <MudPaper Elevation="2" Class="pa-4 rounded-xl d-flex align-center opacity-50 grayscale">
                <MudIcon Icon="@Icons.Material.Filled.BarChart" Color="Color.Secondary" Class="mr-3" />
                <div>
                    <MudText Typo="Typo.body2" Style="font-weight: 600;">Reports</MudText>
                    <MudText Typo="Typo.caption">Coming soon</MudText>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>

</div>

<style>
    .hover-row:hover { background-color: var(--mud-palette-background-grey); }
    .hover-card:hover { transform: translateY(-2px); transition: transform 0.2s; box-shadow: var(--mud-elevation-4); }
    .pointer { cursor: pointer; }
</style>

@code {
    private List<Liability> Liabilities = new();
    private bool IsLoading = true;

    private decimal TotalOriginal => Liabilities.Sum(l => l.OriginalAmount);
    private decimal TotalCurrent  => Liabilities.Sum(l => l.CurrentAmount);
    private decimal TotalPaidOff  => TotalOriginal - TotalCurrent;

    private int OverallPayoffPct =>
        TotalOriginal > 0
            ? (int)Math.Clamp(TotalPaidOff / TotalOriginal * 100, 0, 100)
            : 0;

    private int     OverdueCount => Liabilities.Count(l => l.DueDate < DateTime.Today);
    private decimal OverdueTotal => Liabilities.Where(l => l.DueDate < DateTime.Today).Sum(l => l.CurrentAmount);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        StateHasChanged();
        try
        {
            await Task.Run(() =>
            {
                Liabilities = LiabilityService.GetAllLiabilities();
            });
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load data: {ex.Message}", Severity.Error);
            Console.WriteLine($"DASHBOARD ERROR: {ex}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshData()
    {
        Snackbar.Add("Refreshing...", Severity.Info);
        await LoadData();
        Snackbar.Add("Dashboard updated.", Severity.Success);
    }
}
