@page "/transactions"
@using Application.Services.Transactions
@using Application.Interfaces
@using Application.DTO
@using TransactionEntity = Domain.Entities.Transaction
@rendermode InteractiveServer

@inject ITransactionService TransactionService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IDialogService DialogService
@inject IJSRuntime JS

<PageTitle>Transactions â€” PAccountant</PageTitle>

<div class="d-flex justify-content-between align-center mb-4">
    <MudText Typo="Typo.h5">Transactions</MudText>
    <MudButton OnClick="OpenCreateDialog" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">Add Transaction</MudButton>
</div>

<MudGrid Class="mb-4">
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Transactions</MudText>
            <MudText Typo="Typo.h5">@TransactionList.Count</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Total Amount</MudText>
            <MudText Typo="Typo.h5" Color="Color.Primary">@TotalAmount.ToString("N2")</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">This Month</MudText>
            <MudText Typo="Typo.h5" Color="Color.Success">@ThisMonthCount</MudText>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">This Month Amount</MudText>
            <MudText Typo="Typo.h5" Color="Color.Warning">@ThisMonthAmount.ToString("N2")</MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Class="pa-3 mb-4" Elevation="1">
    <MudGrid>
        <MudItem xs="12" md="4">
            <MudTextField @bind-Value="SearchTerm" Placeholder="Search..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Immediate="true" Clearable="true" Variant="Variant.Outlined" Margin="Margin.Dense" />
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect T="string" Value="@FilterCurrency" ValueChanged="@((string v) => FilterCurrency = v ?? string.Empty)" Label="Currency" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem T="string" Value="@("")">All</MudSelectItem>
                @foreach (var c in Currencies) { <MudSelectItem T="string" Value="@c">@c</MudSelectItem> }
            </MudSelect>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudPaper Elevation="2">
    <MudTable Items="FilteredTransactions" Dense="true" Hover="true" Striped="true" Loading="@IsLoading" LoadingProgressColor="Color.Primary">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Category</MudTh>
            <MudTh>Account</MudTh>
            <MudTh>Amount</MudTh>
            <MudTh>Currency</MudTh>
            <MudTh>Date</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">#@context.Id</MudTd>
            <MudTd DataLabel="Category"><MudChip T="string" Size="Size.Small" Color="GetCategoryColor(context.IdTransactionCategory)">@GetCategoryName(context.IdTransactionCategory)</MudChip></MudTd>
            <MudTd DataLabel="Account">@context.AccountId</MudTd>
            <MudTd DataLabel="Amount"><MudText Color="Color.Primary">@context.Amount.ToString("N2")</MudText></MudTd>
            <MudTd DataLabel="Currency">@context.Currency</MudTd>
            <MudTd DataLabel="Date">@context.TransactionDate.ToString("dd MMM yyyy")</MudTd>
            <MudTd>
                <MudIconButton Icon="@Icons.Material.Filled.Info" Color="Color.Info" OnClick="@(() => NavigationManager.NavigateTo($"/transactions/{context.Id}"))" />
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="@(() => OpenEditDialog(context))" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => OpenDeleteConfirmation(context))" />
            </MudTd>
        </RowTemplate>
        <PagerContent><MudTablePager /></PagerContent>
    </MudTable>
</MudPaper>

@code {
    private List<TransactionEntity> TransactionList = new();
    private bool IsLoading = true;
    private string SearchTerm = string.Empty;
    private string FilterCurrency = string.Empty;
    private List<string> Currencies = new() { "Frw", "USD", "EUR", "GBP", "KES", "UGX", "TZS", "ZAR", "NGN", "GHS" };
    private Dictionary<int, string> TransactionCategories = new() { { 1, "Income" }, { 2, "Expense" }, { 3, "Transfer" }, { 4, "Savings" }, { 5, "Investment" }, { 6, "Loan Payment" }, { 7, "Other" } };

    private decimal TotalAmount => TransactionList.Sum(t => t.Amount);
    private int ThisMonthCount => TransactionList.Count(t => t.TransactionDate.Month == DateTime.Today.Month && t.TransactionDate.Year == DateTime.Today.Year);
    private decimal ThisMonthAmount => TransactionList.Where(t => t.TransactionDate.Month == DateTime.Today.Month && t.TransactionDate.Year == DateTime.Today.Year).Sum(t => t.Amount);

    private IEnumerable<TransactionEntity> FilteredTransactions => TransactionList.Where(t => (string.IsNullOrWhiteSpace(SearchTerm) || t.AccountId.ToString().Contains(SearchTerm) || GetCategoryName(t.IdTransactionCategory).Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) && (string.IsNullOrWhiteSpace(FilterCurrency) || t.Currency == FilterCurrency));

    protected override async Task OnInitializedAsync() { await LoadTransactions(); }

    private async Task LoadTransactions()
    {
        IsLoading = true;
        try { TransactionList = TransactionService.GetAllTransactions(); }
        catch (Exception ex) { Snackbar.Add("Error loading transactions", Severity.Error); }
        finally { IsLoading = false; }
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters<TransactionDialog> { { x => x.Model, new CreateTransactionDTO { TransactionDate = DateTime.Today } }, { x => x.IsEdit, false }, { x => x.TransactionCategories, TransactionCategories }, { x => x.Currencies, Currencies } };
        var dialog = await DialogService.ShowAsync<TransactionDialog>("New Transaction", parameters);
        if (!(await dialog.Result).Canceled) await LoadTransactions();
    }

    private async Task OpenEditDialog(TransactionEntity t)
    {
        var parameters = new DialogParameters<TransactionDialog> { 
            { x => x.Model, new CreateTransactionDTO { 
                IdTransactionCategory = t.IdTransactionCategory, 
                AccountId = t.AccountId, 
                Amount = t.Amount, 
                Currency = t.Currency, 
                TransactionDate = t.TransactionDate, 
                CreatedAt = t.CreatedAt 
            } }, 
            { x => x.IsEdit, true }, 
            { x => x.TransactionId, t.Id }, 
            { x => x.TransactionCategories, TransactionCategories }, 
            { x => x.Currencies, Currencies } 
        };
        var dialog = await DialogService.ShowAsync<TransactionDialog>("Edit Transaction", parameters);
        if (!(await dialog.Result).Canceled) await LoadTransactions();
    }

    private async Task OpenDeleteConfirmation(TransactionEntity t)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Delete transaction #{t.Id}?");
        if (confirmed) { Snackbar.Add("Delete feature coming soon", Severity.Info); }
    }

    private string GetCategoryName(int id) => TransactionCategories.TryGetValue(id, out var name) ? name : $"Category {id}";
    private Color GetCategoryColor(int id) => id switch { 1 => Color.Success, 2 => Color.Error, 3 => Color.Info, 4 => Color.Tertiary, 5 => Color.Primary, 6 => Color.Warning, _ => Color.Default };
}
