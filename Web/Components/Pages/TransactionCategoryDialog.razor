@using  Application.DTO
@using System.ComponentModel.DataAnnotations
@using Domain.Entities
@using Application.Interfaces
@using MudBlazor

@inject ITransactionCategoryService TransactionCategoryService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(IsEdit ? Icons.Material.Filled.Edit : Icons.Material.Filled.Add)" Class="mr-2 mb-n1" />
            @(IsEdit ? "Edit Category" : "Add New Category")
        </MudText>
    </TitleContent>
    <DialogContent>
        <EditForm Model="@Model" OnValidSubmit="SubmitForm">
            <DataAnnotationsValidator />
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField Label="Name" @bind-Value="Model.Name" For="@(() => Model.Name)" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField Label="Type" @bind-Value="Model.Type" For="@(() => Model.Type)" Variant="Variant.Outlined" />
                </MudItem>
            </MudGrid>
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitForm">@(IsEdit ? "Update Category" : "Add Category")</MudButton>
    </DialogActions>
</MudDialog>

@code{
    [CascadingParameter] IMudDialogInstance DialogInstance { get; set; } = default!;

    [Parameter] public TransactionCategoryCreateDTO Model { get; set; } = new();
    [Parameter] public bool IsEdit { get; set; }
    [Parameter] public int CategoryId { get; set; }

    private void SubmitForm()
    {
        try
        {
            if (IsEdit)
            {
                var updateDto = new TransactionCategoryUpdateDTO
                {
                    Name = Model.Name,
                    Type = Model.Type
                };
                TransactionCategoryService.UpdateTransactionCategory(CategoryId, updateDto);
                Snackbar.Add("Category updated successfully!", Severity.Success);
            }
            else
            {
                TransactionCategoryService.CreateTransactionCategory(Model);
                Snackbar.Add("Category created successfully!", Severity.Success);
            }
            DialogInstance.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => DialogInstance.Cancel();
}